# TODO - 残タスクリスト

**プロジェクト**: AI Chat
**最終更新**: 2025-12-11
**現在のフェーズ**: Phase 5 完了（デプロイ準備完了）

---

## 📊 進捗サマリー

- **完了**: Phase 0-5 の主要機能実装
- **テストカバレッジ**:
  - E2E: 18/23 合格 (78.3%)
  - Unit: 28/28 合格 (100%)
  - Integration: 基本テストのみ
- **本番準備**: Docker化、CI/CD完了

---

## 🔴 優先度: 高（High Priority）

本番環境デプロイ前に必須の実装

### 1. セキュリティ・認証

#### 1.1 レート制限の実装
- **ファイル**: `src/server/middleware/rateLimit.ts`
- **説明**: API乱用防止のためのレート制限ミドルウェア
- **実装内容**:
  - IP ベースのレート制限（例: 100リクエスト/分）
  - チャットエンドポイントの制限（例: 10メッセージ/分）
  - Redis または Memory Store を使用
- **影響**: セキュリティ、コスト削減
- **推定工数**: 3-4時間
- **参考**: [Hono Rate Limit](https://hono.dev/middleware/builtin/rate-limiter)

```typescript
// 実装例
import { rateLimiter } from 'hono/rate-limiter'

export const chatRateLimit = rateLimiter({
  windowMs: 60 * 1000, // 1分
  limit: 10, // 最大10リクエスト
  standardHeaders: 'draft-6',
  keyGenerator: (c) => c.req.header('x-forwarded-for') || 'anonymous',
})
```

#### 1.2 入力バリデーション強化
- **ファイル**: `src/server/api/routes/chat.ts`
- **説明**: メッセージの最大長、文字種制限
- **実装内容**:
  - メッセージ最大長: 2000文字
  - 不正な文字列のサニタイズ
  - XSS対策の強化
- **影響**: セキュリティ
- **推定工数**: 2時間

```typescript
const chatRequestSchema = z.object({
  conversationId: z.string().optional(),
  message: z.string().min(1).max(2000).trim(),
})
```

#### 1.3 環境変数の必須チェック
- **ファイル**: `src/lib/mastra/config.ts`, `src/lib/prisma.ts`
- **説明**: 起動時に必須環境変数をチェック
- **実装内容**:
  - ANTHROPIC_API_KEY の存在確認
  - DATABASE_URL の存在確認
  - 欠けている場合はエラーで起動失敗
- **影響**: 運用安定性
- **推定工数**: 1時間

### 2. エラーハンドリング改善

#### 2.1 ストリーミングエラー時のロールバック
- **ファイル**: `src/server/api/routes/chat.ts`
- **説明**: AI応答失敗時にユーザーメッセージを削除
- **実装内容**:
  - try-catch でエラーキャッチ
  - エラー時に保存済みユーザーメッセージを削除
  - トランザクション処理の実装
- **影響**: データ整合性
- **推定工数**: 2-3時間

#### 2.2 グローバルエラーバウンダリ
- **ファイル**: `src/app/error.tsx` (既存)
- **説明**: エラー詳細のログ送信
- **実装内容**:
  - エラー内容をログサービスに送信
  - ユーザーフレンドリーなエラーメッセージ
- **影響**: デバッグ効率
- **推定工数**: 2時間

### 3. MongoDB Atlas セットアップ
- **説明**: 本番環境用データベース
- **実装内容**:
  - MongoDB Atlas クラスター作成
  - Replica Set 構成
  - ネットワークアクセス設定（Cloud Run IP許可）
  - データベースユーザー作成
  - 接続文字列を Secret Manager に登録
- **影響**: 本番環境必須
- **推定工数**: 1-2時間
- **参考**: [MongoDB Atlas Docs](https://docs.atlas.mongodb.com/)

---

## 🟡 優先度: 中（Medium Priority）

品質向上のための実装

### 4. テストカバレッジ向上

#### 4.1 コンポーネントのユニットテスト
**不足しているテスト**:
- [ ] `tests/unit/components/ChatContainer.test.tsx`
- [ ] `tests/unit/components/ChatSidebar.test.tsx`
- [ ] `tests/unit/components/ChatMessage.test.tsx`
- [ ] `tests/unit/components/ChatInput.test.tsx`
- [ ] `tests/unit/components/ThemeProvider.test.tsx`

**推定工数**: 各1-2時間（合計: 5-10時間）

#### 4.2 カスタムフックのテスト
**不足しているテスト**:
- [ ] `tests/unit/hooks/useChat.test.ts`

**実装内容**:
- メッセージ送信機能のテスト
- ストリーミング処理のテスト
- エラーハンドリングのテスト
- ローディング状態のテスト

**推定工数**: 3-4時間

#### 4.3 統合テストの追加
**不足しているテスト**:
- [ ] `tests/integration/api/chat.test.ts` - チャットAPIストリーミング
- [ ] `tests/integration/api/conversations.test.ts` - 会話管理API

**実装内容**:
- POST /api/chat のストリーミングレスポンステスト
- 全ての会話管理エンドポイントのテスト
- エラーケースのテスト

**推定工数**: 各2-3時間（合計: 4-6時間）

### 5. パフォーマンス最適化

#### 5.1 Lighthouse スコア確認・改善
- **目標**: 90+ スコア
- **実装内容**:
  - Performance: 90+
  - Accessibility: 90+
  - Best Practices: 90+
  - SEO: 90+
- **推定工数**: 3-4時間

#### 5.2 バンドルサイズ最適化
- **ファイル**: `next.config.js`
- **実装内容**:
  - webpack-bundle-analyzer の導入
  - 不要な依存関係の削除
  - Dynamic Import の活用
  - Tree Shaking の確認
- **推定工数**: 2-3時間

#### 5.3 画像最適化
- **実装内容**:
  - next/image の活用確認
  - WebP 形式の使用
  - 適切なサイズ設定
- **推定工数**: 1-2時間

### 6. アクセシビリティ改善

#### 6.1 ARIA 属性の適切な使用
- **ファイル**: 全コンポーネント
- **実装内容**:
  - aria-label の追加
  - role 属性の適切な設定
  - フォーカス管理の改善
- **推定工数**: 3-4時間

#### 6.2 スクリーンリーダー対応
- **実装内容**:
  - VoiceOver / NVDA でのテスト
  - アナウンス順序の最適化
  - 動的コンテンツの通知
- **推定工数**: 2-3時間

#### 6.3 キーボードナビゲーション強化
- **実装内容**:
  - Tab キーでの移動確認
  - Escape キーでのモーダルクローズ
  - ショートカットキーの追加
- **推定工数**: 2時間

#### 6.4 カラーコントラスト比の確認
- **目標**: WCAG AA 基準（4.5:1）
- **実装内容**:
  - テキストと背景のコントラスト確認
  - ダークモードでの確認
  - 改善が必要な箇所の修正
- **推定工数**: 2時間

---

## 🟢 優先度: 低（Low Priority）

将来的な改善・拡張機能

### 7. 機能拡張

#### 7.1 会話タイトル自動生成
- **ファイル**: `src/server/services/conversationService.ts`
- **説明**: 最初のメッセージから会話タイトルを自動生成
- **実装内容**:
  - Claude API を使用してタイトル生成
  - 30文字以内に要約
  - 非同期処理で実装
- **推定工数**: 3-4時間

#### 7.2 メッセージ編集・削除機能
- **説明**: ユーザーメッセージの編集・削除
- **実装内容**:
  - PATCH /api/messages/:id
  - DELETE /api/messages/:id
  - UI での編集・削除ボタン追加
- **推定工数**: 4-5時間

#### 7.3 会話のエクスポート機能
- **説明**: 会話を JSON / Markdown でエクスポート
- **実装内容**:
  - GET /api/conversations/:id/export?format=json|markdown
  - ダウンロードボタンの追加
  - ファイル名の自動生成
- **推定工数**: 3-4時間

#### 7.4 マークダウンプレビュー
- **ファイル**: `src/components/chat/ChatInput.tsx`
- **説明**: 入力中のマークダウンをリアルタイムプレビュー
- **実装内容**:
  - プレビュートグルボタン
  - react-markdown での表示
  - スタイリング調整
- **推定工数**: 2-3時間

### 8. 開発体験（DX）改善

#### 8.1 API ドキュメント作成
- **ツール**: Swagger / OpenAPI
- **実装内容**:
  - 全エンドポイントのドキュメント化
  - リクエスト/レスポンス例
  - エラーコード一覧
- **推定工数**: 4-5時間

#### 8.2 Storybook 導入
- **説明**: UIコンポーネントのカタログ化
- **実装内容**:
  - Storybook のセットアップ
  - 各コンポーネントのストーリー作成
  - インタラクションテスト
- **推定工数**: 6-8時間

#### 8.3 Docker Compose 開発環境
- **ファイル**: `docker-compose.yml`
- **説明**: ワンコマンドで開発環境構築
- **実装内容**:
  - MongoDB Replica Set
  - Next.js dev server
  - ホットリロード設定
- **推定工数**: 2-3時間

---

## ⚪ オプション機能

本番運用後の拡張機能

### 9. モニタリング・観測性

#### 9.1 Sentry 統合
- **説明**: エラートラッキング
- **実装内容**:
  - Sentry SDK のインストール
  - エラーキャプチャの設定
  - Source Maps のアップロード
- **推定工数**: 2-3時間
- **参考**: [Sentry Next.js](https://docs.sentry.io/platforms/javascript/guides/nextjs/)

#### 9.2 Google Analytics / Plausible
- **説明**: アクセス解析
- **実装内容**:
  - GA4 または Plausible の導入
  - イベントトラッキング設定
  - プライバシー設定
- **推定工数**: 2-3時間

#### 9.3 Application Performance Monitoring (APM)
- **ツール**: Datadog / New Relic
- **説明**: パフォーマンス監視
- **実装内容**:
  - APM エージェントのインストール
  - カスタムメトリクスの設定
  - アラート設定
- **推定工数**: 3-4時間

### 10. 認証・マルチユーザー対応

#### 10.1 NextAuth.js 統合
- **説明**: ユーザー認証機能
- **実装内容**:
  - Google / GitHub OAuth
  - セッション管理
  - ユーザー固有の会話管理
  - Prisma スキーマ拡張（User モデル）
- **推定工数**: 8-10時間
- **参考**: [NextAuth.js](https://next-auth.js.org/)

#### 10.2 ユーザープロファイル
- **説明**: ユーザー設定画面
- **実装内容**:
  - プロファイル編集
  - API 使用量確認
  - 設定保存（テーマ、言語など）
- **推定工数**: 4-5時間

### 11. 高度な AI 機能

#### 11.1 プロンプトテンプレート
- **説明**: 定型プロンプトの保存・管理
- **実装内容**:
  - テンプレート CRUD API
  - UI での選択・適用
  - 変数置換機能
- **推定工数**: 5-6時間

#### 11.2 モデル選択機能
- **説明**: Claude Sonnet / Opus / Haiku の切り替え
- **実装内容**:
  - モデル選択 UI
  - モデル別の設定管理
  - コスト表示
- **推定工数**: 3-4時間

#### 11.3 ファイルアップロード（Vision）
- **説明**: 画像アップロード・解析
- **実装内容**:
  - ファイルアップロード API
  - Cloud Storage 統合
  - Claude Vision API 連携
- **推定工数**: 6-8時間

#### 11.4 RAG（Retrieval-Augmented Generation）
- **説明**: ナレッジベース検索統合
- **実装内容**:
  - Vector Database（Pinecone / Weaviate）
  - ドキュメント埋め込み
  - コンテキスト検索
- **推定工数**: 10-12時間

---

## 🔧 技術的負債・リファクタリング

### 12. コード品質改善

#### 12.1 TypeScript strict モード完全対応
- **説明**: any 型の排除
- **実装内容**:
  - 全ての any を適切な型に置き換え
  - unknown 型の活用
  - 型ガードの追加
- **推定工数**: 3-4時間

#### 12.2 共通ユーティリティ関数の整理
- **ファイル**: `src/lib/utils.ts`
- **説明**: 重複コードの統合
- **実装内容**:
  - 日付フォーマット関数
  - エラーメッセージ生成関数
  - バリデーション関数
- **推定工数**: 2-3時間

#### 12.3 環境変数の型安全性
- **ファイル**: `src/lib/env.ts`
- **説明**: 環境変数のスキーマ定義
- **実装内容**:
  - Zod で環境変数スキーマ定義
  - 起動時バリデーション
  - 型安全なアクセス
- **推定工数**: 2時間

```typescript
// 実装例
import { z } from 'zod'

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  ANTHROPIC_API_KEY: z.string().min(1),
  NODE_ENV: z.enum(['development', 'production', 'test']),
})

export const env = envSchema.parse(process.env)
```

---

## 📚 ドキュメント

### 13. ドキュメント整備

#### 13.1 コントリビューションガイド
- **ファイル**: `CONTRIBUTING.md`
- **内容**:
  - 開発環境セットアップ
  - コーディング規約
  - プルリクエストの作成方法
  - コミットメッセージ規約
- **推定工数**: 2-3時間

#### 13.2 アーキテクチャドキュメント
- **ファイル**: `docs/ARCHITECTURE.md`
- **内容**:
  - システム構成図
  - データフロー
  - 技術スタックの選定理由
  - ディレクトリ構造の説明
- **推定工数**: 3-4時間

#### 13.3 API ドキュメント
- **ファイル**: `docs/API.md`
- **内容**:
  - 全エンドポイントの詳細
  - リクエスト/レスポンス例
  - エラーコード一覧
  - レート制限情報
- **推定工数**: 4-5時間

---

## 📋 チェックリスト: 本番デプロイ前

デプロイ前に必ず確認すること：

### 必須項目
- [ ] MongoDB Atlas クラスター作成・設定完了
- [ ] GCP Secret Manager に環境変数登録
- [ ] GitHub Secrets 設定完了
- [ ] レート制限実装完了
- [ ] 入力バリデーション強化完了
- [ ] 環境変数の必須チェック実装
- [ ] エラーハンドリング改善完了
- [ ] セキュリティ脆弱性スキャン（npm audit）
- [ ] E2E テスト全て合格
- [ ] ユニットテスト全て合格
- [ ] Lighthouse スコア 90+ 達成
- [ ] モバイル表示確認
- [ ] ダークモード動作確認
- [ ] プロダクションビルド成功確認

### 推奨項目
- [ ] Sentry エラートラッキング設定
- [ ] Google Analytics / Plausible 設定
- [ ] バックアップ戦略の確立
- [ ] 監視アラート設定
- [ ] ログ保持ポリシー確認
- [ ] コスト見積もり完了

---

## 🎯 マイルストーン

### Milestone 6: 本番デプロイ準備完了
**期日**: 2週間以内
**タスク**:
- 優先度: 高のタスク全て完了
- セキュリティチェック完了
- MongoDB Atlas セットアップ完了

### Milestone 7: 品質向上
**期日**: 4週間以内
**タスク**:
- 優先度: 中のタスク全て完了
- テストカバレッジ 90%+ 達成
- パフォーマンス最適化完了
- アクセシビリティ WCAG AA 準拠

### Milestone 8: 機能拡張
**期日**: 8週間以内
**タスク**:
- 優先度: 低のタスク選択的に完了
- ユーザー認証機能追加
- 高度な AI 機能追加

---

## 📝 メモ

### 推定工数合計
- **優先度: 高**: 14-19時間
- **優先度: 中**: 25-37時間
- **優先度: 低**: 20-28時間
- **オプション**: 40-55時間

**合計**: 約99-139時間（約2.5-3.5週間のフルタイム作業）

### 次のアクション
1. 優先度: 高のタスクから順に実装
2. 各タスク完了後、このファイルを更新
3. 定期的にレビュー・見直し

---

**最終更新者**: Claude Sonnet 4.5
**作成日**: 2025-12-11
